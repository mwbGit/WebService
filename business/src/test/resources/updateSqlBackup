
============================================================================
-- 2017-01-09 某城市日绩效车补汇总
SELECT
	SUM(dos.car_allowance)
FROM
	i360r_hop.`t_deliveronly_order_history` doh
INNER JOIN i360r_hop.t_deliveronly_order_store dos ON dos.order_id = doh.id
WHERE
	doh.end_time >= '2016-12-27'
AND doh.end_time < '2017-01-01'
AND doh.status_id = 6
AND doh.city_name = '温州'
AND doh.delivered_by_code IN (
	SELECT DISTINCT
		(delivery_staff_code)
	FROM
		i360r_oas.`t_delivery_staff_daily_performance`
	WHERE
		statistic_date >= '2016-12-27'
	AND statistic_date < '2017-01-01'
	AND city_name = '温州'
	AND position_code = 'DIRECT_MANAGEMENT_FULL_TIME_DELIVERY_STAFF'
);

============================================================================
-- 2017-01-09 宁波温州12月份薪资使用公司车辆扣款问题的确认
SELECT "宁波", b.employee_name, s.item_name, s.amount, s.note
FROM
t_employee_salary_bill_supplement s INNER JOIN t_employee_salary_bill b ON s.salary_bill_id = b.id
WHERE s.note IS NOT NULL
AND s.note LIKE "%车%"
AND b.city_salary_id IN (636)
LIMIT 100;

SELECT "温州", b.employee_name, s.item_name, s.amount, s.note
FROM
t_employee_salary_bill_supplement s INNER JOIN t_employee_salary_bill b ON s.salary_bill_id = b.id
WHERE s.note IS NOT NULL
AND s.note LIKE "%车%"
AND b.city_salary_id IN (634)
LIMIT 100;

####################################
-- 2016-12-20 查询宁波和温州在职的使用公司车辆的员工
SELECT e.id, city.`name` AS cityName, ba.`name` AS baName, e.full_name 
	FROM i360r_cds.t_delivery_staff ds
	INNER JOIN i360r_cds.t_business_area ba ON ds.business_area_id = ba.id
	INNER JOIN i360r_cds.t_city city ON ba.city_id = city.id
	INNER JOIN i360r_cds.t_employee_position ep ON ep.id = ds.employee_position_id
	INNER JOIN i360r_cds.t_employee e ON ep.employee_id = e.id
	WHERE ds.is_company_vehicles_used = "Y"
	AND city.`name` IN ('宁波', '温州')
AND e.status_id != 2

####################################
-- 2016-12-02 检查阶梯提成，薪资与月绩效表不一样的名单

SELECT 
-- temp1.eid, 
cityName, baName, full_name,
temp1.delivered_ladder_order_royalties AS "正确阶梯提成", 
temp2.ladder_order_royalties AS "错误阶梯提成", 
temp1.delivered_ladder_order_royalties - temp2.ladder_order_royalties AS "薪资差额",
temp1.delivered_ladder_order_number AS "正确阶梯提成单量"
FROM
	(
		SELECT e.id AS eid, mp.delivered_ladder_order_number, sum(mp.delivered_ladder_order_royalties) AS delivered_ladder_order_royalties, city.`name` AS cityName, ba.`name` AS baName, e.full_name 		
		FROM i360r_oas.t_delivery_staff_monthly_performance mp
		INNER JOIN i360r_cds.t_delivery_staff ds ON ds.id = mp.delivery_staff_code
		INNER JOIN i360r_cds.t_business_area ba ON ds.business_area_id = ba.id
		INNER JOIN i360r_cds.t_city city ON ba.city_id = city.id
		INNER JOIN i360r_cds.t_employee_position ep ON ep.id = ds.employee_position_id
		INNER JOIN i360r_cds.t_employee e ON ep.employee_id = e.id		
		WHERE mp.statistic_date = '2016-11-01' 
		GROUP BY e.id
		
	) AS temp1
INNER JOIN 
	(
		SELECT esb.employee_code, esb.ladder_order_royalties 
		FROM i360r_oas.t_employee_city_salary ecs
		INNER JOIN i360r_oas.t_employee_salary_bill esb ON ecs.id = esb.city_salary_id
		WHERE ecs.create_time LIKE '2016-12%' 
		AND ecs.status_id  IN (3, 4, 5)

	) AS temp2
ON temp1.eid = temp2.employee_code
WHERE temp1.delivered_ladder_order_royalties != temp2.ladder_order_royalties

-- 2016-12-02 查询排名奖
SELECT  esb.employee_name, esb.ranking_award, esb.attendance_award 
FROM `t_employee_salary_bill` esb
INNER JOIN i360r_cds.t_employee_position ep ON ep.id=esb.employee_position_code
INNER JOIN i360r_cds.t_delivery_staff ds ON ds.employee_position_id=esb.employee_position_code
INNER JOIN i360r_cds.t_business_area ba ON ba.id=ds.business_area_id
INNER JOIN t_employee_city_salary ecs ON ecs.id=esb.city_salary_id
WHERE ba.`name`='西直门' 
AND ecs.create_time  LIKE '2016-12%'
AND esb.attendance_award
-- AND esb.ranking_award>0 


####################################
-- 2016-11-18 “落地配提成”单独发放工资

-- t_deliveronly_order表中is_use_store_royalties_config字段值等于N，就是阶梯提成订单。
-- deliver_type_id判断是不是落地配


-- 既是落地配 又是阶梯提成的 商家数量
SELECT DISTINCT
	(dos.store_account_code)
FROM
	t_deliveronly_order_history doh
INNER JOIN t_deliveronly_order_store dos ON doh.id = dos.order_id
WHERE
	doh.end_time > '2016-11-01'
AND dos.is_use_store_royalties_config = 'N'
AND dos.deliver_type_id = 9


-- 既是落地配 又是阶梯提成的 订单数量
SELECT 
	count(doh.id)
FROM
	t_deliveronly_order_history doh
INNER JOIN t_deliveronly_order_store dos ON doh.id = dos.order_id
WHERE
	doh.end_time > '2016-11-01'
AND dos.is_use_store_royalties_config = 'N'
AND dos.deliver_type_id = 9


####################################
-- 2016-11-15 
-- 菜鸟同城每单提成从11月1日改为6元每单，添加距离补贴
-- 升级脚本见git，有存储过程

-- 1. 当前订单，兼职、全职配送员固定单提成和距离补贴
-- t_deliveronly_order, create_time>11月1日，按照deliver_distance（单位为米，需要换算为公里）修改allowance_deliver_distance
use i360r_rop;
update t_deliveronly_order
set allowance_deliver_distance=
  if(floor(deliver_distance/1000-3)>0 ,floor(deliver_distance/1000-3) , 0),
  parttime_fixed_royalties_amount=6,
  fulltime_fixed_royalties_amount=6
where create_time>='2016-11-01' and partner_id='6';

-- 2. 历史订单，兼职、全职配送员固定单提成和距离补贴
-- t_deliveronly_order_history, end_time>11月1日，按照deliver_distance（单位为米，需要换算为公里）修改allowance_deliver_distance
use i360r_hop;
update t_deliveronly_order_history doh 
INNER JOIN t_deliveronly_order_store dos ON doh.id=dos.order_id
set doh.allowance_deliver_distance=
  if(floor(doh.deliver_distance/1000-3)>0,
    floor(doh.deliver_distance/1000-3),0),
  dos.parttime_fixed_royalties_amount=6,
  dos.fulltime_fixed_royalties_amount=6
where doh.end_time>='2016-11-01' 
and doh.partner_code='6';


-- 菜鸟同城的每单提成从11月1日起，需要改为6元每单；添加距离补贴：超过3公里，每增加一公里，补贴1元。

-- 1. 菜鸟同城 partner_id (code) 为6，t_partner，t_partner_store_config关联的 t_deliveronly_store 
USE i360r_dop;

UPDATE t_partner_store_config psc
INNER JOIN t_deliveronly_store ds ON ds.partner_store_config_id = psc.id
SET psc.allowance_distance_base = 3,
 psc.allowance_distance_ammount_per_km = 1,
 psc.allowance_distance_max_ammount = 1000
WHERE ds.partner_id = '6';

-- 2.把 t_deliveronly_store 里的菜鸟同城的 parttime_fixed_royalties_amount，fulltime_fixed_royalties_amount也修改为6 
update t_deliveronly_store set parttime_fixed_royalties_amount=6,fulltime_fixed_royalties_amount=6 where partner_id='6';


-- 3.  更新 t_delivery_staff_daily_performance、t_delivery_staff_monthly_performance 
--     字段deliver_distance_allowance / delivered_fixed_order_royalties
use i360r_oas;
-- 修改日统计
DROP PROCEDURE if EXISTS t_oas_cainiao_daily_performance;
DELIMITER //
CREATE PROCEDURE t_oas_cainiao_daily_performance()
BEGIN
DECLARE  i int DEFAULT 1;
DECLARE i_date date;
declare error int default 0;
declare continue handler for sqlexception set error = 1;

start transaction;

read_loop:loop
if i <10 then
  set i_date=CONCAT('2016-11-0',i);
else
  set i_date=CONCAT('2016-11-',i);
end if;

-- 修改距离补贴
UPDATE t_delivery_staff_daily_performance dsdp
INNER JOIN (
	SELECT
		sum(
			doh1.allowance_deliver_distance
		) AS allowance_deliver_distance,
		doh1.partner_code,
		doh1.delivered_by_code
	FROM
		i360r_hop.t_deliveronly_order_history doh1
	WHERE
		doh1.end_time >= i_date
	AND doh1.end_time < date_sub(i_date, INTERVAL - 1 DAY)
	AND doh1.partner_code = '6'
	AND doh1.status_id = 6
	GROUP BY
		doh1.delivered_by_code
) doh ON dsdp.delivery_staff_code = doh.delivered_by_code
SET dsdp.deliver_distance_allowance = dsdp.deliver_distance_allowance + ifnull(
	doh.allowance_deliver_distance,
	0
)
WHERE
	dsdp.statistic_date = i_date
AND doh.partner_code = '6';

-- 修改固定单提成
UPDATE t_delivery_staff_daily_performance dsdp
INNER JOIN (
	SELECT
		count(doh1.id) AS delivered_fixed_order_number,
		doh1.partner_code,
		doh1.delivered_by_code
	FROM
		i360r_hop.t_deliveronly_order_history doh1
	WHERE
		doh1.end_time >= i_date
	AND doh1.end_time < date_sub(i_date, INTERVAL - 1 DAY)
	AND doh1.partner_code = '6'
	AND doh1.status_id = 6
	GROUP BY
		doh1.delivered_by_code
) doh ON dsdp.delivery_staff_code = doh.delivered_by_code
SET dsdp.delivered_fixed_order_royalties = dsdp.delivered_fixed_order_royalties + doh.delivered_fixed_order_number * 2
WHERE
	doh.partner_code = '6'
AND dsdp.statistic_date = i_date;

set i=i+1;
if i_date>=(SELECT CURDATE()) then
  leave read_loop;
end if;
end loop;
if(error = 0) then
	commit;
else
	rollback;
end if;
end//
DELIMITER ;

call t_oas_cainiao_daily_performance();
drop procedure t_oas_cainiao_daily_performance;

-- 修改月统计距离补贴
UPDATE t_delivery_staff_monthly_performance dsmp
INNER JOIN (
	SELECT
		sum(
			doh1.allowance_deliver_distance
		) AS allowance_deliver_distance,
		doh1.delivered_by_code,
		doh1.partner_code
	FROM
		i360r_hop.t_deliveronly_order_history doh1
	WHERE
		doh1.end_time >= '2016-11-01'
	AND doh1.partner_code = '6'
	AND doh1.status_id = 6
	GROUP BY
		doh1.delivered_by_code
) doh ON dsmp.delivery_staff_code = doh.delivered_by_code
SET dsmp.deliver_distance_allowance = dsmp.deliver_distance_allowance + ifnull(
	doh.allowance_deliver_distance,
	0
)
WHERE
	doh.partner_code = '6'
AND dsmp.statistic_date = '2016-11-01';

-- 修改月统计固定单提成
UPDATE t_delivery_staff_monthly_performance dsmp
INNER JOIN (
	SELECT
		count(doh1.id) AS delivered_fixed_order_number,
		doh1.delivered_by_code,
		doh1.partner_code
	FROM
		i360r_hop.t_deliveronly_order_history doh1
	WHERE
		doh1.end_time >= '2016-11-01'
	AND doh1.partner_code = '6'
	AND doh1.status_id = 6
	GROUP BY
		doh1.delivered_by_code
) doh ON dsmp.delivery_staff_code = doh.delivered_by_code
SET dsmp.delivered_fixed_order_royalties = dsmp.delivered_fixed_order_royalties + doh.delivered_fixed_order_number * 2
WHERE
	doh.partner_code = '6'
AND dsmp.statistic_date = '2016-11-01';

-- 4. 更新物流统计t_statistics_delivery_station_reference的delivery_staff_salary，需要按商圈
--  更新jsp

####################################
-- 需求描述：固定提成不计算车辆补贴，同时修复已产生的历史数据
-- 2016-11-03 第一次升级，代码已上线
-- 问题：未考虑使用公司车辆的才需要减去车辆补贴，使用自带车辆不需要减去补贴
-- 计算10月份薪资，暴露出来这个bug，月绩效10月份数据已经修复
-- 还需要修复日绩效10月、11月份数据，月绩效11月份数据

-- 修复订单数据，正确
use i360r_hop;
UPDATE t_deliveronly_order_store dos,t_deliveronly_order_history doh 
SET dos.car_allowance=0 
WHERE dos.is_use_store_royalties_config='Y' 
and dos.order_id=doh.id 
and doh.end_time>='2016-10-01 00:00:00';

-- 修复日提成数据，错误
use i360r_oas;
UPDATE t_delivery_staff_daily_performance 
SET car_allowance=car_allowance-delivered_fixed_order_number*0.5 
WHERE create_time>='2016-10-01 00:00:00';

-- 修复月提成数据，错误
UPDATE t_delivery_staff_monthly_performance 
SET car_allowance=car_allowance-delivered_fixed_order_number*0.5 
WHERE create_time>='2016-10-01 00:00:00';

-- 2016-11-05 琴琴第二次升级，只升级了月绩效10月份数据
UPDATE i360r_oas.t_delivery_staff_monthly_performance dsmp
INNER JOIN 
	(
		SELECT doh.delivered_by_code, sum(dos.car_allowance) AS car_allowance 
		FROM i360r_hop.t_deliveronly_order_history doh
		INNER JOIN i360r_hop.t_deliveronly_order_store dos ON doh.id = dos.order_id
		WHERE doh.end_time LIKE '2016-10%' 
		AND doh.status_id = 6 
		GROUP BY doh.delivered_by_code
	) AS temp ON dsmp.delivery_staff_code = temp.delivered_by_code
SET dsmp.car_allowance = temp.car_allowance
WHERE dsmp.statistic_date = '2016-10-01' 
AND dsmp.car_allowance != temp.car_allowance;

-- 10月份薪资，车补数据已经完全修复正确，验证SQL
SELECT temp1.id, temp1.car_allowance AS "正确车补", temp2.car_allowance AS "错误车补", cityName, baName, full_name
FROM
	(
		SELECT e.id, sum(dos.car_allowance) AS car_allowance, city.`name` AS cityName, ba.`name` AS baName, e.full_name 
		FROM i360r_hop.t_deliveronly_order_history doh
		INNER JOIN i360r_hop.t_deliveronly_order_store dos ON doh.id = dos.order_id
		INNER JOIN i360r_cds.t_delivery_staff ds ON ds.id = doh.delivered_by_code
		INNER JOIN i360r_cds.t_business_area ba ON ds.business_area_id = ba.id
		INNER JOIN i360r_cds.t_city city ON ba.city_id = city.id
		INNER JOIN i360r_cds.t_employee_position ep ON ep.id = ds.employee_position_id
		INNER JOIN i360r_cds.t_employee e ON ep.employee_id = e.id
		WHERE doh.end_time LIKE '2016-10%' 
		AND doh.status_id = 6 
		GROUP BY e.id
	) AS temp1
INNER JOIN 
	(
		SELECT esb.employee_code, esb.car_allowance 
		FROM i360r_oas.t_employee_city_salary ecs
		INNER JOIN i360r_oas.t_employee_salary_bill esb ON ecs.id = esb.city_salary_id
		WHERE ecs.`month` = '2016-10' 
		AND ecs.status_id != 7
	) AS temp2
ON temp1.id = temp2.employee_code
WHERE temp1.car_allowance != temp2.car_allowance

-- 2016-11-08 查询月绩效11月份数据是否需要修复
SELECT * 
FROM i360r_oas.t_delivery_staff_monthly_performance dsmp
INNER JOIN 
	(
		SELECT doh.delivered_by_code, sum(dos.car_allowance) AS car_allowance 
		FROM i360r_hop.t_deliveronly_order_history doh
		INNER JOIN i360r_hop.t_deliveronly_order_store dos ON doh.id = dos.order_id
		WHERE doh.end_time LIKE '2016-11%' 
		AND doh.status_id = 6 
		GROUP BY doh.delivered_by_code
	) AS temp ON dsmp.delivery_staff_code = temp.delivered_by_code
WHERE dsmp.statistic_date = '2016-11-01' 
AND dsmp.car_allowance != temp.car_allowance;


-- 2016-11-15 修复 11月份月绩效、10月份 11月份 日绩效
use i360r_oas;
-- 11月份月绩效
UPDATE t_delivery_staff_monthly_performance dsmp
INNER JOIN
	(
		SELECT doh.delivered_by_code, sum(dos.car_allowance) AS car_allowance
		FROM i360r_hop.t_deliveronly_order_history doh
		INNER JOIN i360r_hop.t_deliveronly_order_store dos ON doh.id = dos.order_id
		WHERE doh.end_time LIKE '2016-11%'
		AND doh.status_id = 6
		GROUP BY doh.delivered_by_code
	) AS temp ON dsmp.delivery_staff_code = temp.delivered_by_code
SET dsmp.car_allowance = temp.car_allowance
WHERE dsmp.statistic_date = '2016-11-01'
AND dsmp.car_allowance != temp.car_allowance;

-- 10月份 11月份 日绩效
DROP PROCEDURE if EXISTS t_fix_order_no_car_allowance;
DELIMITER //
CREATE PROCEDURE t_fix_order_no_car_allowance()
BEGIN
DECLARE  i int DEFAULT 0;
DECLARE i_date date;
declare error int default 0;
declare continue handler for sqlexception set error = 1;

start transaction;

read_loop:loop
set i_date=DATE_ADD('2016-10-01',INTERVAL i DAY);

UPDATE t_delivery_staff_daily_performance dsdp
INNER JOIN
	(
		SELECT doh.delivered_by_code, sum(dos.car_allowance) AS car_allowance
		FROM i360r_hop.t_deliveronly_order_history doh
		INNER JOIN i360r_hop.t_deliveronly_order_store dos ON doh.id = dos.order_id
		WHERE doh.end_time LIKE CONCAT(i_date,'%')
		AND doh.status_id = 6
		AND dos.is_use_store_royalties_config='N'
		GROUP BY doh.delivered_by_code
	) AS temp ON dsdp.delivery_staff_code = temp.delivered_by_code
SET dsdp.car_allowance = temp.car_allowance
WHERE dsdp.statistic_date = i_date
AND dsdp.car_allowance != temp.car_allowance;

set i=i+1;
if i_date>=CURDATE() then
  leave read_loop;
end if;
end loop;
if(error = 0) then
	commit;
else
	rollback;
end if;
end//
DELIMITER ;

call t_fix_order_no_car_allowance();
drop procedure t_fix_order_no_car_allowance;

-- 验证SQL
-- 11月份 月绩效，查询为空就对了
SELECT dsmp.car_allowance,temp.car_allowance FROM t_delivery_staff_monthly_performance dsmp
INNER JOIN
	(
		SELECT doh.delivered_by_code, sum(dos.car_allowance) AS car_allowance
		FROM i360r_hop.t_deliveronly_order_history doh
		INNER JOIN i360r_hop.t_deliveronly_order_store dos ON doh.id = dos.order_id
		WHERE doh.end_time LIKE '2016-11%'
		AND doh.status_id = 6
		GROUP BY doh.delivered_by_code
	) AS temp ON dsmp.delivery_staff_code = temp.delivered_by_code
WHERE dsmp.statistic_date = '2016-11-01'
AND dsmp.car_allowance != temp.car_allowance;

-- 10月份 11月份 日绩效，查询为空就对了（日期只能一天天的写，暂时还没想到好办法）
SELECT dsdp.car_allowance,temp.car_allowance,dsdp.delivery_staff_code
FROM t_delivery_staff_daily_performance dsdp
INNER JOIN
	(
		SELECT doh.delivered_by_code, sum(dos.car_allowance) AS car_allowance
		FROM i360r_hop.t_deliveronly_order_history doh
		INNER JOIN i360r_hop.t_deliveronly_order_store dos ON doh.id = dos.order_id
		WHERE doh.end_time LIKE '2016-10-01%'
		AND doh.status_id = 6
		AND dos.is_use_store_royalties_config='N'
		GROUP BY doh.delivered_by_code
	) AS temp ON dsdp.delivery_staff_code = temp.delivered_by_code
WHERE dsdp.statistic_date = '2016-10-01'
AND dsdp.car_allowance != temp.car_allowance;


####################################
-- 需求描述：
-- city_id 010302 深圳
-- 深圳全职配送员薪资提成从十月一日起后台系统调整为500单以上3元
-- 500单以下每单提成2元
-- 2016-11-06 第一次升级，遗留问题：10月份日绩效数据没有修复，11月份日、月绩效数据没有修复，配置没有生效，新订单还没有按照新规则生效

-- 大于500单
UPDATE i360r_oas.t_delivery_staff_monthly_performance dsmp
INNER JOIN i360r_cds.t_delivery_staff ds ON ds.id = dsmp.delivery_staff_code
INNER JOIN i360r_cds.t_business_area ba ON ds.business_area_id = ba.id
INNER JOIN i360r_cds.t_employee_position ep ON ep.id = ds.employee_position_id
INNER JOIN i360r_cds.t_employee e ON ep.employee_id = e.id
SET dsmp.delivered_ladder_order_royalties = (500 -dsmp.delivered_ladder_order_number_base) *2 + (dsmp.delivered_ladder_order_number_base + dsmp.delivered_ladder_order_number - 500)*3
WHERE ba.city_id = '010302' AND dsmp.statistic_date = '2016-10-01' 
AND (dsmp.delivered_ladder_order_number_base + dsmp.delivered_ladder_order_number) > 500 AND ep.position_id NOT IN (52);

-- 小于500单
UPDATE i360r_oas.t_delivery_staff_monthly_performance dsmp
INNER JOIN i360r_cds.t_delivery_staff ds ON ds.id = dsmp.delivery_staff_code
INNER JOIN i360r_cds.t_business_area ba ON ds.business_area_id = ba.id
INNER JOIN i360r_cds.t_employee_position ep ON ep.id = ds.employee_position_id
INNER JOIN i360r_cds.t_employee e ON ep.employee_id = e.id
SET dsmp.delivered_ladder_order_royalties = dsmp.delivered_ladder_order_number *2
WHERE ba.city_id = '010302' AND dsmp.statistic_date = '2016-10-01' 
AND (dsmp.delivered_ladder_order_number_base + dsmp.delivered_ladder_order_number) <= 500 AND ep.position_id NOT IN (52);

-- 验证线上数据是否正确sql
SELECT * FROM i360r_oas.t_delivery_staff_monthly_performance dsmp
INNER JOIN i360r_cds.t_delivery_staff ds ON ds.id = dsmp.delivery_staff_code
INNER JOIN i360r_cds.t_business_area ba ON ds.business_area_id = ba.id
INNER JOIN i360r_cds.t_employee_position ep ON ep.id = ds.employee_position_id
INNER JOIN i360r_cds.t_employee e ON ep.employee_id = e.id
WHERE 
-- 深圳
ba.city_id = '010302' AND 
-- 日期
dsmp.statistic_date = '2016-10-01'
-- 超过500单的
AND (dsmp.delivered_ladder_order_number_base + dsmp.delivered_ladder_order_number) > 500
-- 非兼职配送员，全职配送员、调度、站长、储备干部，注意业务部门需求不准确
AND ep.position_id NOT IN (52)
-- 不存在不等的数据，说明数据全部修复正确
AND dsmp.delivered_ladder_order_royalties != (500 -dsmp.delivered_ladder_order_number_base) *2 + (dsmp.delivered_ladder_order_number_base + dsmp.delivered_ladder_order_number - 500)*3
;

SELECT * FROM i360r_oas.t_delivery_staff_monthly_performance dsmp
INNER JOIN i360r_cds.t_delivery_staff ds ON ds.id = dsmp.delivery_staff_code
INNER JOIN i360r_cds.t_business_area ba ON ds.business_area_id = ba.id
INNER JOIN i360r_cds.t_employee_position ep ON ep.id = ds.employee_position_id
INNER JOIN i360r_cds.t_employee e ON ep.employee_id = e.id
WHERE 
ba.city_id = '010302' AND 
dsmp.statistic_date = '2016-10-01' 
AND (dsmp.delivered_ladder_order_number_base + dsmp.delivered_ladder_order_number) <= 500 
AND ep.position_id NOT IN (52)
AND dsmp.delivered_ladder_order_royalties != dsmp.delivered_ladder_order_number *2
;


-- 2016-11-08 第二次升级，配置生效，11月份日、月绩效数据不用修复（深圳无超过500单的订单），遗留问题：10月份日绩效数据没有修复
delete from t_delivery_staff_royalties_config where business_area_code like '010302%';

insert into t_delivery_staff_royalties_config (from_order_number,to_order_number,royalties,business_area_code,business_area_name,create_time,update_time,created_by_code,updated_by_code,created_by_name,updated_by_name) values 
(1,500,2,'0103020101','福田南','2016-11-07 00:00:00','2016-11-07 00:00:00','10000001','10000001','王超','王超'),
(501,99999999,3,'0103020101','福田南','2016-11-07 00:00:00','2016-11-07 00:00:00','10000001','10000001','王超','王超'),
(1,500,2,'0103020201','后海','2016-11-07 00:00:00','2016-11-07 00:00:00','10000001','10000001','王超','王超'),
(501,99999999,3,'0103020201','后海','2016-11-07 00:00:00','2016-11-07 00:00:00','10000001','10000001','王超','王超'),
(1,500,2,'0103020102','华强北','2016-11-07 00:00:00','2016-11-07 00:00:00','10000001','10000001','王超','王超'),
(501,99999999,3,'0103020102','华强北','2016-11-07 00:00:00','2016-11-07 00:00:00','10000001','10000001','王超','王超'),
(1,500,2,'0103020301','龙华','2016-11-07 00:00:00','2016-11-07 00:00:00','10000001','10000001','王超','王超'),
(501,99999999,3,'0103020301','龙华','2016-11-07 00:00:00','2016-11-07 00:00:00','10000001','10000001','王超','王超'),
(1,500,2,'0103020202','西丽','2016-11-07 00:00:00','2016-11-07 00:00:00','10000001','10000001','王超','王超'),
(501,99999999,3,'0103020202','西丽','2016-11-07 00:00:00','2016-11-07 00:00:00','10000001','10000001','王超','王超'),
(1,500,2,'0103020302','西乡','2016-11-07 00:00:00','2016-11-07 00:00:00','10000001','10000001','王超','王超'),
(501,99999999,3,'0103020302','西乡','2016-11-07 00:00:00','2016-11-07 00:00:00','10000001','10000001','王超','王超'),
(1,500,2,'0103020103','香蜜湖','2016-11-07 00:00:00','2016-11-07 00:00:00','10000001','10000001','王超','王超'),
(501,99999999,3,'0103020103','香蜜湖','2016-11-07 00:00:00','2016-11-07 00:00:00','10000001','10000001','王超','王超'),
(1,500,2,'0103020401','坂田','2016-11-07 00:00:00','2016-11-07 00:00:00','10000001','10000001','王超','王超'),
(501,99999999,3,'0103020401','坂田','2016-11-07 00:00:00','2016-11-07 00:00:00','10000001','10000001','王超','王超'),
(1,500,2,'0103020402','布吉','2016-11-07 00:00:00','2016-11-07 00:00:00','10000001','10000001','王超','王超'),
(501,99999999,3,'0103020402','布吉','2016-11-07 00:00:00','2016-11-07 00:00:00','10000001','10000001','王超','王超'),
(1,500,2,'0103020501','国贸','2016-11-07 00:00:00','2016-11-07 00:00:00','10000001','10000001','王超','王超'),
(501,99999999,3,'0103020501','国贸','2016-11-07 00:00:00','2016-11-07 00:00:00','10000001','10000001','王超','王超'),
(1,500,2,'0103020203','白石洲','2016-11-07 00:00:00','2016-11-07 00:00:00','10000001','10000001','王超','王超'),
(501,99999999,3,'0103020203','白石洲','2016-11-07 00:00:00','2016-11-07 00:00:00','10000001','10000001','王超','王超'),
(1,500,2,'0103020204','科技园','2016-11-07 00:00:00','2016-11-07 00:00:00','10000001','10000001','王超','王超'),
(501,99999999,3,'0103020204','科技园','2016-11-07 00:00:00','2016-11-07 00:00:00','10000001','10000001','王超','王超'),
(1,500,2,'0103020205','蛇口','2016-11-07 00:00:00','2016-11-07 00:00:00','10000001','10000001','王超','王超'),
(501,99999999,3,'0103020205','蛇口','2016-11-07 00:00:00','2016-11-07 00:00:00','10000001','10000001','王超','王超'),
(1,500,2,'0103020303','清湖','2016-11-07 00:00:00','2016-11-07 00:00:00','10000001','10000001','王超','王超'),
(501,99999999,3,'0103020303','清湖','2016-11-07 00:00:00','2016-11-07 00:00:00','10000001','10000001','王超','王超'),
(1,500,2,'0103020104','上下沙','2016-11-07 00:00:00','2016-11-07 00:00:00','10000001','10000001','王超','王超'),
(501,99999999,3,'0103020104','上下沙','2016-11-07 00:00:00','2016-11-07 00:00:00','10000001','10000001','王超','王超'),
(1,500,2,'0103020502','莲塘','2016-11-07 00:00:00','2016-11-07 00:00:00','10000001','10000001','王超','王超'),
(501,99999999,3,'0103020502','莲塘','2016-11-07 00:00:00','2016-11-07 00:00:00','10000001','10000001','王超','王超');

--
-- 2016-11-15 深圳十月份日绩效
use i360r_oas;
DROP PROCEDURE if EXISTS t_shenzhen_october_daily_performance;
DELIMITER //
CREATE PROCEDURE t_shenzhen_october_daily_performance()
BEGIN
DECLARE  i int DEFAULT 0;
DECLARE i_date date;
DECLARE i_delivery_staff_code char(16);
DECLARE i_sum_laddder_order_number int DEFAULT 0;
DECLARE is_over_500 char(1) DEFAULT 'N';
DECLARE error int default 0;

DECLARE done int default false;

DECLARE cur cursor for
SELECT
	DISTINCT(dsdp.delivery_staff_code)
FROM t_delivery_staff_daily_performance dsdp
INNER JOIN i360r_cds.t_delivery_staff ds ON ds.id = dsdp.delivery_staff_code
INNER JOIN i360r_cds.t_business_area ba ON ds.business_area_id = ba.id
INNER JOIN i360r_cds.t_employee_position ep ON ep.id = ds.employee_position_id
WHERE ba.city_id = '010302' and dsdp.statistic_date>='2016-10-01' and dsdp.statistic_date<'2016-11-01' AND ep.position_id NOT IN (52);

DECLARE continue handler for sqlexception set error = 1;
DECLARE continue handler for not found set done = true;

start transaction;
open cur;

read_loop1:loop
fetch next from cur into i_delivery_staff_code;
if done then
		leave read_loop1;
end if;

read_loop2:loop

set i_date= DATE_ADD('2016-10-01',INTERVAL i DAY);

SET i_sum_laddder_order_number = i_sum_laddder_order_number + (
    SELECT dsdp.delivered_ladder_order_number
    FROM t_delivery_staff_daily_performance dsdp
    INNER JOIN i360r_cds.t_delivery_staff ds ON ds.id = dsdp.delivery_staff_code
    INNER JOIN i360r_cds.t_business_area ba ON ds.business_area_id = ba.id
    INNER JOIN i360r_cds.t_employee_position ep ON ep.id = ds.employee_position_id
    WHERE
      ba.city_id = '010302'
    AND dsdp.delivery_staff_code = i_delivery_staff_code
    AND dsdp.statistic_date = i_date AND ep.position_id NOT IN (52)
);

if is_over_500='Y' then
    UPDATE t_delivery_staff_daily_performance dsdp
    INNER JOIN i360r_cds.t_delivery_staff ds ON ds.id = dsdp.delivery_staff_code
    INNER JOIN i360r_cds.t_business_area ba ON ds.business_area_id = ba.id
    INNER JOIN i360r_cds.t_employee_position ep ON ep.id = ds.employee_position_id
    SET dsdp.delivered_ladder_order_royalties = dsdp.delivered_ladder_order_number * 3
    WHERE
      ba.city_id = '010302'
    AND dsdp.delivery_staff_code = i_delivery_staff_code
    AND dsdp.statistic_date = i_date AND ep.position_id NOT IN (52);
end if;

if i_sum_laddder_order_number<=500 then
    UPDATE t_delivery_staff_daily_performance dsdp
    INNER JOIN i360r_cds.t_delivery_staff ds ON ds.id = dsdp.delivery_staff_code
    INNER JOIN i360r_cds.t_business_area ba ON ds.business_area_id = ba.id
    INNER JOIN i360r_cds.t_employee_position ep ON ep.id = ds.employee_position_id
    SET dsdp.delivered_ladder_order_royalties = dsdp.delivered_ladder_order_number * 2
    WHERE
      ba.city_id = '010302'
    AND dsdp.delivery_staff_code = i_delivery_staff_code
    AND dsdp.statistic_date = i_date AND ep.position_id NOT IN (52);
end if;

if i_sum_laddder_order_number>500 and is_over_500='N' then
    UPDATE t_delivery_staff_daily_performance dsdp
    INNER JOIN i360r_cds.t_delivery_staff ds ON ds.id = dsdp.delivery_staff_code
    INNER JOIN i360r_cds.t_business_area ba ON ds.business_area_id = ba.id
    INNER JOIN i360r_cds.t_employee_position ep ON ep.id = ds.employee_position_id
    SET dsdp.delivered_ladder_order_royalties = (i_sum_laddder_order_number-500) * 3
        + (500+dsdp.delivered_ladder_order_number-i_sum_laddder_order_number) * 2
    WHERE
      ba.city_id = '010302'
    AND dsdp.delivery_staff_code = i_delivery_staff_code
    AND dsdp.statistic_date = i_date AND ep.position_id NOT IN (52);

	  set is_over_500='Y';
end if;

set i=i+1;
if i_date>='2016-10-31' then
	set is_over_500='N';
	set i_sum_laddder_order_number=0;
  leave read_loop2;
end if;
end loop;
end loop;
close cur;
if(error = 0) then
	commit;
else
	rollback;
end if;
end//
DELIMITER ;

call t_shenzhen_october_daily_performance();
drop procedure t_shenzhen_october_daily_performance;

--验证：深圳十月份日绩效，查出月绩效与日绩效累加之和不等的，为空就对了
SELECT
	dsmp.delivered_ladder_order_royalties,
	temp.sum_delivered_ladder_order_royalties,dsmp.delivered_ladder_order_number,dsmp.delivery_staff_code
FROM
	t_delivery_staff_monthly_performance dsmp
INNER JOIN (
	SELECT
		dsdp.delivery_staff_code,
		sum(
			dsdp.delivered_ladder_order_royalties
		) AS sum_delivered_ladder_order_royalties
	FROM
		t_delivery_staff_daily_performance dsdp
	INNER JOIN i360r_cds.t_delivery_staff ds ON ds.id = dsdp.delivery_staff_code
	INNER JOIN i360r_cds.t_business_area ba ON ds.business_area_id = ba.id
	INNER JOIN i360r_cds.t_employee_position ep ON ep.id = ds.employee_position_id
	WHERE
		ba.city_id = '010302'
	AND dsdp.statistic_date >= '2016-10-01'
	AND dsdp.statistic_date < '2016-11-01'
	AND ep.position_id NOT IN (52)
	GROUP BY
		dsdp.delivery_staff_code
) temp ON dsmp.delivery_staff_code = temp.delivery_staff_code
INNER JOIN i360r_cds.t_delivery_staff ds ON ds.id = dsmp.delivery_staff_code
INNER JOIN i360r_cds.t_business_area ba ON ds.business_area_id = ba.id
INNER JOIN i360r_cds.t_employee_position ep ON ep.id = ds.employee_position_id
WHERE
	ba.city_id = '010302'
AND dsmp.statistic_date >= '2016-10-01'
AND dsmp.statistic_date < '2016-11-01'
AND ep.position_id NOT IN (52)
AND dsmp.delivered_ladder_order_royalties != temp.sum_delivered_ladder_order_royalties;


####################################
-- 需求描述：10月份薪资，单独重新生成有保险的站长，系统报错
-- 解决思路：查出有问题的员工保险记录，将关联的employee_salary_bill_id置为NULL，设置薪资状态正常

UPDATE `i360r_oas`.`t_employee_insurance` 
SET `employee_salary_bill_id`= NULL 
WHERE 
employee_code IN (
	SELECT temp1.id 
	FROM
		(
			SELECT e.id, sum(dos.car_allowance) AS car_allowance 
			FROM i360r_hop.t_deliveronly_order_history doh
			INNER JOIN i360r_hop.t_deliveronly_order_store dos ON doh.id = dos.order_id
			INNER JOIN i360r_cds.t_delivery_staff ds ON ds.id = doh.delivered_by_code
			INNER JOIN i360r_cds.t_business_area ba ON ds.business_area_id = ba.id
			INNER JOIN i360r_cds.t_employee_position ep ON ep.id = ds.employee_position_id
			INNER JOIN i360r_cds.t_employee e ON ep.employee_id = e.id
			WHERE doh.end_time LIKE '2016-10%' 
			AND doh.status_id = 6 
			GROUP BY e.id
		) AS temp1
	INNER JOIN 
		(
			SELECT esb.employee_code, esb.car_allowance 
			FROM i360r_oas.t_employee_city_salary ecs
			INNER JOIN i360r_oas.t_employee_salary_bill esb ON ecs.id = esb.city_salary_id
			WHERE ecs.`month` = '2016-10' 
			AND ecs.create_time LIKE '2016-11-06%'
		) AS temp2
	ON temp1.id = temp2.employee_code
	WHERE temp1.car_allowance != temp2.car_allowance	
) AND `month` = '2016-10';


UPDATE i360r_oas.t_employee_city_salary SET status_id = 3 WHERE id IN(593,588);


####################################
-- 2016-11-07 
-- 西直门 ，中关村，北太平庄，五道口，月坛，魏公村，回龙观，西三旗
-- 调整商圈内兼职人员提成，提成调整为7.5元/单
-- 车补0.5元，与之前保持一致，不变
USE i360r_oas;
UPDATE t_delivery_staff_royalties_parttime_config 
SET royalties_amount = 7.5 
WHERE location_name IN ('回龙观','西三旗','西直门','中关村','北太平庄','五道口','月坛','魏公村');

-- 验证sql
SELECT * FROM t_delivery_staff_royalties_parttime_config 
WHERE location_name IN ('回龙观','西三旗','西直门','中关村','北太平庄','五道口','月坛','魏公村');

####################################
-- 2016-11-15 
-- 北京东区申请兼职配送费提升至7.5元一单
USE i360r_oas;
UPDATE t_delivery_staff_royalties_parttime_config 
SET royalties_amount = 7.5 
WHERE location_name IN ('东直门','工体','四惠','崇文门','团结湖');

